{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}My Sessions - Mentor Dashboard - PeerLearn{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 md:pl-64">
    <main>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-semibold text-gray-900">My Sessions</h1>
                <div class="hidden md:flex space-x-3">
                    <a href="{% url 'users:mentor_create_advanced_session' %}" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Create Session
                    </a>
                </div>
            </div>
        </div>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
            <!-- Sessions content starts here -->
                <div class="mt-4">
                    <!-- Session tabs -->
                    <div class="sm:hidden">
                        <label for="tabs" class="sr-only">Select a tab</label>
                        <select id="tabs" name="tabs" x-data="{ tab: '{{ sub_tab }}' }" x-model="tab" @change="window.location.href = '{% url 'users:mentor_sessions' %}?tab=' + tab" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md">
                            <option value="today" {% if sub_tab == 'today' %}selected{% endif %}>Today</option>
                            <option value="upcoming" {% if sub_tab == 'upcoming' %}selected{% endif %}>Upcoming</option>
                            <option value="past" {% if sub_tab == 'past' %}selected{% endif %}>Past</option>
                        </select>
                    </div>
                    <div class="hidden sm:block">
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                <a href="{% url 'users:mentor_sessions' %}?tab=today" data-tab="today" class="sub-tab {% if sub_tab == 'today' %}border-primary-500 text-primary-600 active{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                    Today
                                </a>
                                <a href="{% url 'users:mentor_sessions' %}?tab=upcoming" data-tab="upcoming" class="sub-tab {% if sub_tab == 'upcoming' %}border-primary-500 text-primary-600 active{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                    Upcoming
                                </a>
                                <a href="{% url 'users:mentor_sessions' %}?tab=past" data-tab="past" class="sub-tab {% if sub_tab == 'past' %}border-primary-500 text-primary-600 active{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                    Past
                                </a>
                            </nav>
                        </div>
                    </div>

                    <!-- Session lists based on tab -->
                    <div class="mt-6">
                        {% if sub_tab == 'today' %}
                            <!-- Today's sessions -->
                            <div id="today-sessions-content" class="sessions-tab-content" data-tab="today">
                            {% if today_sessions %}
                            <div class="bg-white shadow overflow-hidden sm:rounded-md">
                                <ul class="divide-y divide-gray-200">
                                    {% for session in today_sessions %}
                                    <li id="session-{{ session.id }}" class="session-item" x-data="{ 
                                        countdown: '{{ session.countdown_str }}',
                                        canGoLive: {{ session.can_go_live|lower }},
                                        status: '{{ session.status }}',
                                        intervalId: null,
                                        target: new Date('{{ session.schedule|date:'c' }}'),
                                        now: new Date('{{ current_time }}'),
                                        
                                        updateCountdown() {
                                            this.now = new Date();
                                            
                                            if (this.status === 'live') {
                                                // Session is live, count down remaining time
                                                const durationMinutes = {{ session.duration }};
                                                const endTime = new Date(this.target.getTime() + (durationMinutes * 60000));
                                                const remaining = endTime - this.now;
                                                
                                                if (remaining <= 0) {
                                                    this.countdown = '00:00:00';
                                                    clearInterval(this.intervalId);
                                                    return;
                                                }
                                                
                                                // Format remaining time
                                                const hours = Math.floor(remaining / 3600000);
                                                const minutes = Math.floor((remaining % 3600000) / 60000);
                                                const seconds = Math.floor((remaining % 60000) / 1000);
                                                this.countdown = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                                            } else {
                                                // Session is scheduled, count down until start
                                                const timeUntil = this.target - this.now;
                                                
                                                if (timeUntil <= 0) {
                                                    // It's time to go live
                                                    this.countdown = 'LIVE NOW';
                                                    this.canGoLive = true;
                                                    return;
                                                }
                                                
                                                // Check if within 15 minutes of start time
                                                if (timeUntil <= 15 * 60 * 1000) {
                                                    this.canGoLive = true;
                                                }
                                                
                                                // Format countdown
                                                const hours = Math.floor(timeUntil / 3600000);
                                                const minutes = Math.floor((timeUntil % 3600000) / 60000);
                                                const seconds = Math.floor((timeUntil % 60000) / 1000);
                                                this.countdown = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                                            }
                                        }
                                    }" 
                                    x-init="
                                        updateCountdown();
                                        intervalId = setInterval(() => {
                                            updateCountdown();
                                        }, 1000); // Update every second
                                        $cleanup = () => clearInterval(intervalId);
                                    "
                                    class="block hover:bg-gray-50">
                                        <div class="px-4 py-4 sm:px-6">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <p class="text-lg font-medium text-primary-600 truncate">
                                                        {{ session.title }}
                                                    </p>
                                                    <div class="ml-2 flex-shrink-0 flex">
                                                        <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                                            {% if session.status == 'scheduled' %}bg-blue-100 text-blue-800
                                                            {% elif session.status == 'live' %}bg-green-100 text-green-800
                                                            {% elif session.status == 'completed' %}bg-gray-100 text-gray-800
                                                            {% elif session.status == 'cancelled' %}bg-red-100 text-red-800
                                                            {% endif %}">
                                                            {{ session.status|title }}
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="ml-2 flex-shrink-0 flex items-center">
                                                    <div x-show="canGoLive && status === 'scheduled'" class="mr-4">
                                                        <a href="/session/{{ session.room_code }}/go-live/" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                                            <svg class="-ml-0.5 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                                            </svg>
                                                            Go Live
                                                        </a>
                                                    </div>
                                                    <div x-show="status === 'live'" class="mr-4">
                                                        <a href="/session/{{ session.room_code }}/" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                                            <svg class="-ml-0.5 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                              <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" />
                                                            </svg>
                                                            Join Session
                                                        </a>
                                                    </div>
                                                    <div class="flex items-center text-sm text-gray-500">
                                                        <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                                                        </svg>
                                                        <span x-text="countdown" class="tabular-nums"></span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-2 sm:flex sm:justify-between">
                                                <div class="sm:flex">
                                                    <p class="flex items-center text-sm text-gray-500">
                                                        <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                                        </svg>
                                                        {{ session.schedule|date:"F j, Y P" }}
                                                    </p>
                                                    <p class="mt-2 flex items-center text-sm text-gray-500 sm:mt-0 sm:ml-6">
                                                        <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                                                        </svg>
                                                        <span class="participant-counter" data-current="{{ session.confirmed_bookings_count }}" data-max="{{ session.max_participants }}">
                                                            <span class="count-display font-semibold text-primary-600">{{ session.confirmed_bookings_count }}</span> / {{ session.max_participants }} Participants
                                                        </span>
                                                    </p>
                                                    <p class="mt-2 flex items-center text-sm text-gray-500 sm:mt-0 sm:ml-6">
                                                        <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                                        </svg>
                                                        {% if session.price > 0 %}₹{{ session.price }}{% else %}Free{% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% else %}
                            <div class="text-center py-12 bg-white shadow rounded-md">
                                <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <h3 class="mt-2 text-lg font-medium text-gray-900">No sessions today</h3>
                                <p class="mt-1 text-sm text-gray-500">You don't have any sessions scheduled for today.</p>
                                <div class="mt-6">
                                    <a href="{% url 'users:mentor_create_advanced_session' %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                        <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                        </svg>
                                        Create New Session
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        {% elif sub_tab == 'upcoming' %}
                            <!-- Upcoming sessions -->
                            <div id="upcoming-sessions-content" class="sessions-tab-content" data-tab="upcoming">
                            {% if upcoming_sessions %}
                            <div class="bg-white shadow overflow-hidden sm:rounded-md">
                                <ul class="divide-y divide-gray-200">
                                    {% for session in upcoming_sessions %}
                                    <li x-data="{ 
                                        countdown: '{{ session.countdown_str }}',
                                        showEditMenu: false,
                                        canEdit: {{ session.can_edit|lower }},
                                        intervalId: null,
                                        target: new Date('{{ session.schedule|date:'c' }}'),
                                        now: new Date('{{ current_time }}'),
                                        
                                        updateCountdown() {
                                            this.now = new Date();
                                            
                                            // Count down until start
                                            const timeUntil = this.target - this.now;
                                            
                                            if (timeUntil <= 0) {
                                                this.countdown = 'LIVE NOW';
                                                clearInterval(this.intervalId);
                                                return;
                                            }
                                            
                                            // Format countdown
                                            const days = Math.floor(timeUntil / (24 * 3600000));
                                            const hours = Math.floor((timeUntil % (24 * 3600000)) / 3600000);
                                            const minutes = Math.floor((timeUntil % 3600000) / 60000);
                                            const seconds = Math.floor((timeUntil % 60000) / 1000);
                                            
                                            if (days > 0) {
                                                this.countdown = `${days}d ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                                            } else {
                                                this.countdown = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                                            }
                                            
                                            // Update edit permission (can't edit within 5 minutes of start)
                                            this.canEdit = timeUntil > 5 * 60 * 1000;
                                        }
                                    }" 
                                    x-init="
                                        updateCountdown();
                                        intervalId = setInterval(() => {
                                            updateCountdown();
                                        }, 1000); // Update every second
                                        $cleanup = () => clearInterval(intervalId);
                                    "
                                    class="block hover:bg-gray-50 relative">
                                        <div class="px-4 py-4 sm:px-6">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <p class="text-lg font-medium text-primary-600 truncate">
                                                        {{ session.title }}
                                                    </p>
                                                    <div class="ml-2 flex-shrink-0 flex">
                                                        <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                                            Scheduled
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="ml-2 flex space-x-4 items-center">
                                                    <div class="flex items-center text-sm text-gray-500">
                                                        <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                                                        </svg>
                                                        <span x-text="countdown" class="tabular-nums"></span>
                                                    </div>
                                                    
                                                    <!-- Edit/Cancel Menu Button -->
                                                    <div class="relative ml-3" x-data="{ open: false }">
                                                        <div>
                                                            <button @click="open = !open" type="button" class="inline-flex items-center p-1.5 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                        
                                                        <div x-show="open" 
                                                             @click.away="open = false"
                                                             x-transition:enter="transition ease-out duration-100"
                                                             x-transition:enter-start="transform opacity-0 scale-95"
                                                             x-transition:enter-end="transform opacity-100 scale-100"
                                                             x-transition:leave="transition ease-in duration-75"
                                                             x-transition:leave-start="transform opacity-100 scale-100"
                                                             x-transition:leave-end="transform opacity-0 scale-95"
                                                             class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 z-10">
                                                            
                                                            <a x-show="canEdit" href="{% url 'users:mentor_session_edit' session.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                                <svg class="inline-block mr-2 h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                </svg>
                                                                Edit Session
                                                            </a>
                                                            
                                                            <button x-show="!canEdit" disabled class="block w-full text-left px-4 py-2 text-sm text-gray-400 cursor-not-allowed">
                                                                <svg class="inline-block mr-2 h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                </svg>
                                                                Cannot Edit (Too Close to Start)
                                                            </button>
                                                            
                                                            <a href="#" onclick="confirmCancelSession({{ session.id }}, '{{ session.title|escapejs }}'); return false;" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                                                                <svg class="inline-block mr-2 h-4 w-4 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                </svg>
                                                                Cancel Session
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-2 sm:flex sm:justify-between">
                                                <div class="sm:flex">
                                                    <p class="flex items-center text-sm text-gray-500">
                                                        <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                                        </svg>
                                                        {{ session.schedule|date:"F j, Y P" }}
                                                    </p>
                                                    <p class="mt-2 flex items-center text-sm text-gray-500 sm:mt-0 sm:ml-6">
                                                        <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                                                        </svg>
                                                        <span class="participant-counter" data-current="{{ session.confirmed_bookings_count }}" data-max="{{ session.max_participants }}">
                                                            <span class="count-display font-semibold text-primary-600">{{ session.confirmed_bookings_count }}</span> / {{ session.max_participants }} Participants
                                                        </span>
                                                    </p>
                                                    <p class="mt-2 flex items-center text-sm text-gray-500 sm:mt-0 sm:ml-6">
                                                        <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                                        </svg>
                                                        {% if session.price > 0 %}₹{{ session.price }}{% else %}Free{% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% else %}
                            <div class="text-center py-12 bg-white shadow rounded-md">
                                <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <h3 class="mt-2 text-lg font-medium text-gray-900">No upcoming sessions</h3>
                                <p class="mt-1 text-sm text-gray-500">You don't have any sessions scheduled for future days.</p>
                                <div class="mt-6">
                                    <a href="{% url 'users:mentor_create_advanced_session' %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                        <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                        </svg>
                                        Create New Session
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        {% else %}
                            <!-- Past sessions -->
                            <div id="past-sessions-content" class="sessions-tab-content" data-tab="past">
                            {% if past_sessions %}
                            <div class="bg-white shadow overflow-hidden sm:rounded-md">
                                <ul class="divide-y divide-gray-200">
                                    {% for session in past_sessions %}
                                    <li class="block hover:bg-gray-50">
                                        <div class="px-4 py-4 sm:px-6">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <p class="text-lg font-medium text-gray-700 truncate">
                                                        {{ session.title }}
                                                    </p>
                                                    <div class="ml-2 flex-shrink-0 flex">
                                                        <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                                            {% if session.status == 'completed' %}bg-blue-100 text-blue-800
                                                            {% elif session.status == 'cancelled' %}bg-red-100 text-red-800
                                                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                            {{ session.status|title }}
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="ml-2 flex-shrink-0 flex items-center">
                                                    {% if session.status == 'completed' %}
                                                    <a href="/session/{{ session.room_code }}/recording/" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                                        <svg class="-ml-0.5 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                          <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                                                        </svg>
                                                        View Recording
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="mt-2 sm:flex sm:justify-between">
                                                <div class="sm:flex">
                                                    <p class="flex items-center text-sm text-gray-500">
                                                        <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                                        </svg>
                                                        {{ session.schedule|date:"F j, Y P" }}
                                                    </p>
                                                    <p class="mt-2 flex items-center text-sm text-gray-500 sm:mt-0 sm:ml-6">
                                                        <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                                                        </svg>
                                                        <span class="participant-counter">
                                                            <span class="count-display font-semibold text-gray-600">{{ session.confirmed_bookings_count }}</span> / {{ session.max_participants }} Participants
                                                        </span>
                                                    </p>
                                                    <p class="mt-2 flex items-center text-sm text-gray-500 sm:mt-0 sm:ml-6">
                                                        <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                                        </svg>
                                                        {% if session.price > 0 %}₹{{ session.price }}{% else %}Free{% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% else %}
                            <div class="text-center py-12 bg-white shadow rounded-md">
                                <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <h3 class="mt-2 text-lg font-medium text-gray-900">No past sessions</h3>
                                <p class="mt-1 text-sm text-gray-500">You haven't taught any sessions yet.</p>
                                <div class="mt-6">
                                    <a href="{% url 'users:mentor_create_advanced_session' %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                        <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                        </svg>
                                        Create Your First Session
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            `;
        }
    });
</script>

<!-- Session Cancel Modal JavaScript -->
<script>
    function confirmCancelSession(sessionId, sessionTitle) {
        if (confirm(`Are you sure you want to cancel your session "${sessionTitle}"? This will notify all booked learners.`)) {
            // Call the API client method to cancel the session
            apiClient.cancelSession(sessionId, 'Cancelled by mentor')
                .then(data => {
                    if (data.success) {
                        showToast('success', 'Session Cancelled', 'Your session has been cancelled and learners have been notified.');
                        // Delay for toast to be visible
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showToast('error', 'Error', data.error || 'There was an error cancelling the session.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('error', 'Error', 'There was an error communicating with the server.');
                });
        }
    }
</script>

{% block extra_js %}
<script>
    // Initialize and handle real-time updates for sessions
    document.addEventListener('DOMContentLoaded', function() {
        // Mark tabs with class for easier selection
        const tabLinks = document.querySelectorAll('.border-b-2');
        tabLinks.forEach(link => {
            link.classList.add('sessions-tab-link');
        });
        
        // Mark tab content sections with data attributes
        const todayContent = document.querySelector('#today-sessions-content');
        if (todayContent) todayContent.setAttribute('data-tab', 'today');
        
        const upcomingContent = document.querySelector('#upcoming-sessions-content');
        if (upcomingContent) upcomingContent.setAttribute('data-tab', 'upcoming');
        
        const pastContent = document.querySelector('#past-sessions-content');
        if (pastContent) pastContent.setAttribute('data-tab', 'past');
        
        // Set classes for tab content
        const allContents = document.querySelectorAll('[data-tab]');
        allContents.forEach(content => {
            content.classList.add('sessions-tab-content');
        });
        
        // Set up event listeners for the tab links
        setupSessionTabHandlers();
        
        // Initialize session timers
        initializeSessionTimers();
    });
    
    // Set up event handlers for session tabs
    function setupSessionTabHandlers() {
        const tabLinks = document.querySelectorAll('.sessions-tab-link');
        tabLinks.forEach(link => {
            link.addEventListener('click', handleTabClick);
        });
    }
    
    // Handle tab click to update content without page reload
    function handleTabClick(event) {
        event.preventDefault();
        
        // Get the tab value from the href
        const url = new URL(event.currentTarget.href);
        const tabValue = url.searchParams.get('tab');
        
        // Update URL without reloading page
        window.history.pushState({tab: tabValue}, '', event.currentTarget.href);
        
        // Update active tab indicator
        updateActiveTabUI(tabValue);
        
        // No need for AJAX here since the content is already in the page
        // Just show/hide the appropriate tab content
        showTabContent(tabValue);
    }
    
    // Update the active tab indicator in the UI
    function updateActiveTabUI(activeTab) {
        const tabLinks = document.querySelectorAll('.sessions-tab-link');
        
        tabLinks.forEach(link => {
            const url = new URL(link.href);
            const tabValue = url.searchParams.get('tab');
            
            if (tabValue === activeTab) {
                link.classList.add('border-primary-500', 'text-primary-600');
                link.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            } else {
                link.classList.remove('border-primary-500', 'text-primary-600');
                link.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            }
        });
        
        // Update mobile selector if present
        const mobileSelector = document.getElementById('tabs');
        if (mobileSelector) {
            mobileSelector.value = activeTab;
        }
    }
    
    // Show the content for the selected tab
    function showTabContent(activeTab) {
        const allTabContents = document.querySelectorAll('.sessions-tab-content');
        
        allTabContents.forEach(content => {
            if (content.getAttribute('data-tab') === activeTab) {
                content.classList.remove('hidden');
            } else {
                content.classList.add('hidden');
            }
        });
    }
    
    // Initialize timers for session countdowns
    function initializeSessionTimers() {
        // Add data attributes to all session items
        document.querySelectorAll('.session-item').forEach(item => {
            const sessionId = item.getAttribute('id').replace('session-', '');
            const countdownElement = item.querySelector('.session-countdown');
            
            if (countdownElement) {
                // Set attributes for timer updates
                countdownElement.setAttribute('data-session-id', sessionId);
                countdownElement.setAttribute('data-countdown', 'true');
                
                // Extract schedule datetime from existing format
                const scheduleText = item.querySelector('.session-schedule').getAttribute('datetime');
                countdownElement.setAttribute('data-target', scheduleText);
                
                // Get duration from duration badge
                const durationText = item.querySelector('.session-duration').textContent;
                const duration = parseInt(durationText.match(/\d+/)[0]);
                countdownElement.setAttribute('data-duration', duration);
                
                // Get status from status badge
                const statusText = item.querySelector('.session-status').textContent.toLowerCase();
                countdownElement.setAttribute('data-status', statusText);
            }
        });
        
        // Start timers
        const sessionTimers = document.querySelectorAll('[data-countdown]');
        
        sessionTimers.forEach(timer => {
            const sessionId = timer.getAttribute('data-session-id');
            const targetTime = new Date(timer.getAttribute('data-target'));
            const duration = parseInt(timer.getAttribute('data-duration'));
            const status = timer.getAttribute('data-status');
            
            // Set up interval to update the timer
            updateSessionTimer(timer, targetTime, duration, status);
            const intervalId = setInterval(() => {
                updateSessionTimer(timer, targetTime, duration, status);
            }, 1000);
            
            // Store the interval ID to clear it when needed
            timer.setAttribute('data-interval-id', intervalId);
        });
    }
    
    // Update a single session timer display
    function updateSessionTimer(timerElement, targetTime, durationMinutes, status) {
        const now = new Date();
        
        if (status === 'live') {
            // Session is live, count down remaining time
            const endTime = new Date(targetTime.getTime() + (durationMinutes * 60000));
            const remaining = endTime - now;
            
            if (remaining <= 0) {
                timerElement.textContent = '00:00:00';
                const intervalId = timerElement.getAttribute('data-interval-id');
                if (intervalId) {
                    clearInterval(parseInt(intervalId));
                }
                return;
            }
            
            // Format remaining time
            const hours = Math.floor(remaining / 3600000);
            const minutes = Math.floor((remaining % 3600000) / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        } else {
            // Session is scheduled, count down until start
            const timeUntil = targetTime - now;
            
            if (timeUntil <= 0) {
                timerElement.textContent = 'LIVE NOW';
                // Check if we need to update the UI to show Go Live button
                const sessionItem = timerElement.closest('.session-item');
                const goLiveButton = sessionItem.querySelector('.go-live-button');
                if (goLiveButton) {
                    goLiveButton.classList.remove('hidden');
                }
                return;
            }
            
            // Check if within 15 minutes of start time
            if (timeUntil <= 15 * 60 * 1000) {
                const sessionItem = timerElement.closest('.session-item');
                const goLiveButton = sessionItem.querySelector('.go-live-button');
                if (goLiveButton) {
                    goLiveButton.classList.remove('hidden');
                }
            }
            
            // Format countdown
            const hours = Math.floor(timeUntil / 3600000);
            const minutes = Math.floor((timeUntil % 3600000) / 60000);
            const seconds = Math.floor((timeUntil % 60000) / 1000);
            timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }
    
    // Initialize tab functionality
    document.addEventListener('DOMContentLoaded', function() {
        initTabFunctionality();
    });
    
    function initTabFunctionality() {
        // First, make sure all session content tabs have the correct display state
        const activeTab = document.querySelector('.sub-tab.active');
        if (activeTab) {
            const tabName = activeTab.dataset.tab;
            
            // Hide all tab contents
            document.querySelectorAll('.sessions-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Show the active tab content
            const activeContent = document.querySelector(`.sessions-tab-content[data-tab="${tabName}"]`);
            if (activeContent) {
                activeContent.style.display = 'block';
            }
        }
        
        // Add click handlers for tabs (in case JavaScript navigation is preferred over server-side)
        document.querySelectorAll('.sub-tab').forEach(tab => {
            tab.addEventListener('click', function(e) {
                // The default href navigation will still work, but this allows for potential AJAX loading
                // of session data in the future without full page reloads
                const tabName = this.dataset.tab;
                console.log(`Tab clicked: ${tabName}`);
                
                // Update active state of tabs
                document.querySelectorAll('.sub-tab').forEach(t => {
                    t.classList.remove('active', 'border-primary-500', 'text-primary-600');
                    t.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                });
                
                this.classList.add('active', 'border-primary-500', 'text-primary-600');
                this.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });
        });
    }
</script>
{% endblock %}

{% endblock %}