{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}My Sessions - Mentor Dashboard - PeerLearn{% endblock %}

{% block content %}
<div x-data="sessionManager()" class="min-h-screen bg-gray-50 md:pl-64">
    <main>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-semibold text-gray-900">My Sessions</h1>
                <div class="hidden md:flex space-x-3">
                    <a href="{% url 'users:mentor_create_advanced_session' %}" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition duration-150 ease-in-out transform hover:scale-105">
                        <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Create Session
                    </a>
                </div>
            </div>
        </div>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
            <!-- Sessions content starts here -->
            <div class="mt-4">
                <!-- Session tabs -->
                <div class="sm:hidden">
                    <label for="tabs" class="sr-only">Select a tab</label>
                    <select id="tabs" name="tabs" x-data="{ tab: '{{ sub_tab }}' }" x-model="tab" @change="window.location.href = '{% url 'users:mentor_sessions' %}?tab=' + tab" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md">
                        <option value="today" {% if sub_tab == 'today' %}selected{% endif %}>Today</option>
                        <option value="upcoming" {% if sub_tab == 'upcoming' %}selected{% endif %}>Upcoming</option>
                        <option value="past" {% if sub_tab == 'past' %}selected{% endif %}>Past</option>
                    </select>
                </div>
                <div class="hidden sm:block">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <a href="{% url 'users:mentor_sessions' %}?tab=today" 
                               data-tab="today" 
                               id="tab-today"
                               class="sub-tab {% if sub_tab == 'today' %}border-primary-500 text-primary-600 active{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                Today
                            </a>
                            <a href="{% url 'users:mentor_sessions' %}?tab=upcoming" 
                               data-tab="upcoming" 
                               id="tab-upcoming"
                               class="sub-tab {% if sub_tab == 'upcoming' %}border-primary-500 text-primary-600 active{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                Upcoming
                            </a>
                            <a href="{% url 'users:mentor_sessions' %}?tab=past" 
                               data-tab="past" 
                               id="tab-past"
                               class="sub-tab {% if sub_tab == 'past' %}border-primary-500 text-primary-600 active{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                Past
                            </a>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="mt-6" x-data="sessionManager()">
                {% if not has_any_sessions %}
                    <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-12 bg-white shadow rounded-md">
                        <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <h3 class="mt-2 text-lg font-medium text-gray-900">No sessions found</h3>
                        <p class="mt-1 text-sm text-gray-500">You don't have any {{ sub_tab }} sessions. Create a new session to get started.</p>
                        <div class="mt-6">
                            <a href="{% url 'users:mentor_create_advanced_session' %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition duration-150 ease-in-out">
                                <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Create a new session
                            </a>
                        </div>
                    </div>
                {% else %}
                    <!-- Display Today Sessions -->
                    {% if sub_tab == 'today' %}
                        <div class="sessions-list grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                            {% for session in today_sessions %}
                                <div class="bg-white shadow rounded-lg overflow-hidden border border-gray-200 transition duration-200 ease-in-out hover:shadow-md"
                                    data-session-id="{{ session.id }}"
                                    x-data="{ 
                                        showOptionsMenu: false, 
                                        isBusy: false,
                                        sessionId: {{ session.id }}
                                    }">
                                    
                                    <!-- Session header with title and status -->
                                    <div class="px-4 pt-5 pb-2 sm:px-6">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1">
                                                <h3 class="text-lg font-semibold text-gray-900 truncate">{{ session.title }}</h3>
                                                
                                                <!-- Status badges -->
                                                <div class="mt-1 flex items-center space-x-2">
                                                    <span class="status-badge px-2.5 py-0.5 rounded-full text-xs font-medium
                                                        {% if session.status == 'scheduled' %}bg-gray-100 text-gray-800
                                                        {% elif session.status == 'live' %}bg-red-100 text-red-800
                                                        {% elif session.status == 'completed' %}bg-blue-100 text-blue-800
                                                        {% elif session.status == 'cancelled' %}bg-yellow-100 text-yellow-800{% endif %}">
                                                        {% if session.status == 'live' %}LIVE NOW{% else %}{{ session.status|title }}{% endif %}
                                                    </span>
                                                    
                                                    <!-- Participants badge -->
                                                    <span class="booking-badge px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                        {{ session.confirmed_bookings_count }} / {{ session.max_participants }} Booked
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- Dropdown menu for options -->
                                            <div class="relative">
                                                <button @click="showOptionsMenu = !showOptionsMenu" type="button" class="inline-flex items-center p-1.5 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500" aria-expanded="true" aria-haspopup="true">
                                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                                                    </svg>
                                                </button>
                                                
                                                <!-- Dropdown menu -->
                                                <div x-show="showOptionsMenu" @click.away="showOptionsMenu = false" class="z-10 origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 divide-y divide-gray-100" role="menu" aria-orientation="vertical">
                                                    <div class="py-1">
                                                        {% if session.status == 'scheduled' %}
                                                            <a href="{% url 'users:mentor_session_edit' session_id=session.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                                <svg class="inline-block mr-2 h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                </svg>
                                                                Edit Session
                                                            </a>
                                                            
                                                            <a href="#" @click.prevent="cancelSession(sessionId)" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                                                                <svg class="inline-block mr-2 h-4 w-4 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                </svg>
                                                                Cancel Session
                                                            </a>
                                                        {% endif %}
                                                        
                                                        {% if session.status == 'completed' %}
                                                            <a href="/sessions/{{ session.id }}/analytics/" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                                <svg class="inline-block mr-2 h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                                                </svg>
                                                                View Analytics
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Session details -->
                                    <div class="px-4 py-4 sm:px-6">
                                        <div class="space-y-3">
                                            <!-- Date and time -->
                                            <div class="flex items-center text-sm text-gray-600">
                                                <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                                </svg>
                                                <span>{{ session.schedule|date:"D, M j, Y" }} at {{ session.schedule|date:"g:i A" }}</span>
                                            </div>
                                            
                                            <!-- Duration -->
                                            <div class="flex items-center text-sm text-gray-600">
                                                <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                                                </svg>
                                                <span>{{ session.duration }} minutes</span>
                                            </div>
                                            
                                            <!-- Countdown timer (when scheduled) -->
                                            {% if session.status == 'scheduled' %}
                                            <div class="flex items-center text-sm font-medium">
                                                <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-primary-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                                                </svg>
                                                <span class="countdown-display text-primary-600">
                                                    Starts in <span 
                                                        data-countdown="true" 
                                                        data-countdown-type="start"
                                                        data-session-id="{{ session.id }}"
                                                        data-session-time="{{ session.schedule|date:'c' }}">
                                                        {% if session.countdown_str %}
                                                            {{ session.countdown_str }}
                                                        {% else %}
                                                            calculating...
                                                        {% endif %}
                                                    </span>
                                                </span>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Session is live indicator -->
                                            {% if session.is_live %}
                                            <div class="flex items-center text-sm font-medium">
                                                <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                                                </svg>
                                                <span class="text-red-600 animate-pulse">LIVE NOW - Join the session!</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Action buttons -->
                                    <div class="px-4 py-4 sm:px-6 bg-gray-50 border-t border-gray-200 flex flex-wrap gap-2 justify-end">
                                        <!-- Go Live button (only for scheduled sessions that are ready to go live) -->
                                        {% if session.status == 'scheduled' and session.can_go_live %}
                                            <button @click="goLive({{ session.id }})" :disabled="isBusy"
                                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed transition duration-150 ease-in-out"
                                                title="Start this session now">
                                                <svg x-show="!isBusy" class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                                </svg>
                                                <svg x-show="isBusy" class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                Go Live Now
                                            </button>
                                        {% endif %}
                                        
                                        <!-- Enter Room button (if already live) -->
                                        {% if session.status == 'live' %}
                                            <a href="/sessions/{{ session.room_code }}/join/?direct=true&mentor=true"
                                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                                                <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" />
                                                </svg>
                                                Join Room
                                            </a>
                                        {% endif %}
                                        
                                        <!-- Edit button (only for scheduled sessions) -->
                                        {% if session.status == 'scheduled' %}
                                            <a href="{% url 'users:mentor_session_edit' session_id=session.id %}"
                                                class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition duration-150 ease-in-out">
                                                <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                                </svg>
                                                Edit
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Display Upcoming Sessions -->
                    {% if sub_tab == 'upcoming' %}
                        <div class="sessions-list grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                            {% for session in upcoming_sessions %}
                                <div class="bg-white shadow rounded-lg overflow-hidden border border-gray-200 transition duration-200 ease-in-out hover:shadow-md"
                                    x-data="{ 
                                        showOptionsMenu: false, 
                                        isBusy: false,
                                        sessionId: {{ session.id }}
                                    }">
                                    
                                    <!-- Session header with title and status -->
                                    <div class="px-4 pt-5 pb-2 sm:px-6">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1">
                                                <h3 class="text-lg font-semibold text-gray-900 truncate">{{ session.title }}</h3>
                                                
                                                <!-- Status badges -->
                                                <div class="mt-1 flex items-center space-x-2">
                                                    <span class="px-2.5 py-0.5 rounded-full text-xs font-medium
                                                        {% if session.status == 'scheduled' %}bg-gray-100 text-gray-800
                                                        {% elif session.status == 'live' %}bg-red-100 text-red-800
                                                        {% elif session.status == 'completed' %}bg-blue-100 text-blue-800
                                                        {% elif session.status == 'cancelled' %}bg-yellow-100 text-yellow-800{% endif %}">
                                                        {{ session.status|title }}
                                                    </span>
                                                    
                                                    <!-- Participants badge -->
                                                    <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                        {{ session.confirmed_bookings_count }} / {{ session.max_participants }} Booked
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- Dropdown menu for options -->
                                            <div class="relative">
                                                <button @click="showOptionsMenu = !showOptionsMenu" type="button" class="inline-flex items-center p-1.5 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500" aria-expanded="true" aria-haspopup="true">
                                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                                                    </svg>
                                                </button>
                                                
                                                <!-- Dropdown menu -->
                                                <div x-show="showOptionsMenu" @click.away="showOptionsMenu = false" class="z-10 origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 divide-y divide-gray-100" role="menu" aria-orientation="vertical">
                                                    <div class="py-1">
                                                        <a href="{% url 'users:mentor_session_edit' session_id=session.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                            <svg class="inline-block mr-2 h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                            </svg>
                                                            Edit Session
                                                        </a>
                                                        
                                                        <a href="#" @click.prevent="cancelSession(sessionId)" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                                                            <svg class="inline-block mr-2 h-4 w-4 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                            Cancel Session
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Session details -->
                                    <div class="px-4 py-4 sm:px-6">
                                        <div class="space-y-3">
                                            <!-- Date and time -->
                                            <div class="flex items-center text-sm text-gray-600">
                                                <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                                </svg>
                                                <span>{{ session.schedule|date:"D, M j, Y" }} at {{ session.schedule|date:"g:i A" }}</span>
                                            </div>
                                            
                                            <!-- Duration -->
                                            <div class="flex items-center text-sm text-gray-600">
                                                <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                                                </svg>
                                                <span>{{ session.duration }} minutes</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action buttons -->
                                    <div class="px-4 py-4 sm:px-6 bg-gray-50 border-t border-gray-200 flex flex-wrap gap-2 justify-end">
                                        <!-- Only show Go Live button for upcoming sessions that are ready to go live -->
                                        {% if session.can_go_live %}
                                            <button @click="goLive(sessionId)" :disabled="isBusy"
                                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed transition duration-150 ease-in-out">
                                                <svg x-show="!isBusy" class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                                </svg>
                                                <svg x-show="isBusy" class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                Go Live Now
                                            </button>
                                        {% endif %}
                                        
                                        <!-- Edit button -->
                                        <a href="{% url 'users:mentor_session_edit' session_id=session.id %}"
                                            class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition duration-150 ease-in-out">
                                            <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                            </svg>
                                            Edit
                                        </a>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Display Past Sessions -->
                    {% if sub_tab == 'past' %}
                        <div class="sessions-list grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                            {% for session in past_sessions %}
                                <div class="bg-white shadow rounded-lg overflow-hidden border border-gray-200 transition duration-200 ease-in-out hover:shadow-md"
                                    x-data="{ 
                                        showOptionsMenu: false,
                                        sessionId: {{ session.id }}
                                    }">
                                    
                                    <!-- Session header with title and status -->
                                    <div class="px-4 pt-5 pb-2 sm:px-6">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1">
                                                <h3 class="text-lg font-semibold text-gray-900 truncate">{{ session.title }}</h3>
                                                
                                                <!-- Status badges -->
                                                <div class="mt-1 flex items-center space-x-2">
                                                    <span class="px-2.5 py-0.5 rounded-full text-xs font-medium
                                                        {% if session.status == 'completed' %}bg-blue-100 text-blue-800
                                                        {% elif session.status == 'cancelled' %}bg-yellow-100 text-yellow-800{% endif %}">
                                                        {{ session.status|title }}
                                                    </span>
                                                    
                                                    <!-- Participants badge -->
                                                    <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                        {{ session.confirmed_bookings_count }} / {{ session.max_participants }} Attended
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- Dropdown menu for options -->
                                            <div class="relative">
                                                <button @click="showOptionsMenu = !showOptionsMenu" type="button" class="inline-flex items-center p-1.5 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500" aria-expanded="true" aria-haspopup="true">
                                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                                                    </svg>
                                                </button>
                                                
                                                <!-- Dropdown menu -->
                                                <div x-show="showOptionsMenu" @click.away="showOptionsMenu = false" class="z-10 origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 divide-y divide-gray-100" role="menu" aria-orientation="vertical">
                                                    <div class="py-1">
                                                        {% if session.status == 'completed' %}
                                                            <a href="/sessions/{{ session.id }}/analytics/" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                                <svg class="inline-block mr-2 h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                                                </svg>
                                                                View Analytics
                                                            </a>
                                                            <a href="#" @click.prevent="cloneSession(sessionId)" class="block px-4 py-2 text-sm text-green-600 hover:bg-gray-100">
                                                                <svg class="inline-block mr-2 h-4 w-4 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
                                                                </svg>
                                                                Clone Session
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Session details -->
                                    <div class="px-4 py-4 sm:px-6">
                                        <div class="space-y-3">
                                            <!-- Date and time -->
                                            <div class="flex items-center text-sm text-gray-600">
                                                <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                                </svg>
                                                <span>{{ session.schedule|date:"D, M j, Y" }} at {{ session.schedule|date:"g:i A" }}</span>
                                            </div>
                                            
                                            <!-- Duration -->
                                            <div class="flex items-center text-sm text-gray-600">
                                                <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                                                </svg>
                                                <span>{{ session.duration }} minutes</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action buttons -->
                                    <div class="px-4 py-4 sm:px-6 bg-gray-50 border-t border-gray-200 flex flex-wrap gap-2 justify-end">
                                        {% if session.status == 'completed' %}
                                            <!-- View analytics button -->
                                            <a href="/sessions/{{ session.id }}/analytics/"
                                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition duration-150 ease-in-out">
                                                <svg class="-ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
                                                </svg>
                                                View Analytics
                                            </a>
                                            
                                            <!-- Clone session button -->
                                            <button @click="cloneSession(sessionId)" 
                                                class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition duration-150 ease-in-out">
                                                <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" />
                                                    <path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h8a2 2 0 00-2-2H5z" />
                                                </svg>
                                                Clone Session
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    function sessionManager() {
        return {
            isBusy: false,
            wsConnection: null,
            hasSessionWebSocket: false,
            mentorId: document.querySelector('meta[name="user-id"]')?.getAttribute('content'),
            csrfToken: document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
            
            init() {
                // Initialize the WebSocket connection
                this.setupWebSocket();
                
                // Set up interval for countdown updates
                this.setupCountdownUpdates();
                
                // Listen for document visibility changes to reconnect WebSocket if needed
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible' && !this.hasSessionWebSocket) {
                        console.log('Document became visible, reconnecting WebSocket...');
                        this.setupWebSocket();
                    }
                });
            },
            
            setupWebSocket() {
                if (!this.mentorId) {
                    console.warn('No mentor ID found, cannot setup session WebSocket');
                    return;
                }
                
                // Close existing connection if any
                if (this.wsConnection) {
                    this.wsConnection.close();
                }
                
                // Determine WebSocket protocol (ws or wss)
                const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
                const wsUrl = `${protocol}//${window.location.host}/ws/sessions/`;
                
                console.log(`Connecting to session WebSocket at ${wsUrl}`);
                this.wsConnection = new WebSocket(wsUrl);
                
                this.wsConnection.onopen = () => {
                    console.log('Session WebSocket connected');
                    this.hasSessionWebSocket = true;
                    
                    // Subscribe to mentor's sessions channel
                    this.wsConnection.send(JSON.stringify({
                        type: 'subscribe',
                        channel: `sessions:${this.mentorId}`
                    }));
                    
                    // Fetch initial session data
                    this.wsConnection.send(JSON.stringify({
                        type: 'fetch_sessions'
                    }));
                };
                
                this.wsConnection.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    console.log('Session WebSocket message:', data);
                    
                    // Handle different event types
                    switch (data.type) {
                        case 'new_booking':
                            this.handleNewBooking(data);
                            break;
                        case 'session.updated':
                            this.handleSessionUpdated(data);
                            break;
                        case 'session.cancelled':
                            this.handleSessionCancelled(data);
                            break;
                        case 'session.live':
                            this.handleSessionLive(data);
                            break;
                        case 'learner.join':
                        case 'learner.leave':
                            this.handleLearnerActivity(data);
                            break;
                    }
                };
                
                this.wsConnection.onclose = (event) => {
                    console.log('Session WebSocket closed', event);
                    this.hasSessionWebSocket = false;
                    
                    // Attempt to reconnect after a delay
                    setTimeout(() => {
                        if (document.visibilityState === 'visible') {
                            console.log('Attempting to reconnect to session WebSocket...');
                            this.setupWebSocket();
                        }
                    }, 5000);
                };
                
                this.wsConnection.onerror = (error) => {
                    console.error('Session WebSocket error:', error);
                };
            },
            
            setupCountdownUpdates() {
                // Update all countdowns every second
                setInterval(() => {
                    document.querySelectorAll('[data-countdown]').forEach(el => {
                        const sessionTime = new Date(el.dataset.sessionTime).getTime();
                        const now = new Date().getTime();
                        const diff = sessionTime - now;
                        
                        if (diff <= 0) {
                            // Session time has passed
                            if (el.dataset.countdownType === 'start') {
                                // For session start countdown
                                el.textContent = 'Started';
                                el.parentElement.classList.add('text-red-500');
                                
                                // Enable Go Live button automatically if it exists
                                const goLiveBtn = document.querySelector(`[data-session-id="${el.dataset.sessionId}"] .go-live-btn`);
                                if (goLiveBtn) {
                                    goLiveBtn.disabled = false;
                                    goLiveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                                    goLiveBtn.classList.add('hover:bg-primary-700');
                                }
                            } else {
                                // For other countdown types
                                el.textContent = 'Ended';
                            }
                        } else {
                            // Format and display the countdown
                            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                            
                            // Different formats based on how much time is left
                            let countdownText = '';
                            if (days > 0) {
                                countdownText = `${days}d ${hours}h ${minutes}m`;
                            } else if (hours > 0) {
                                countdownText = `${hours}h ${minutes}m ${seconds}s`;
                            } else {
                                countdownText = `${minutes}m ${seconds}s`;
                                
                                // Within 15 minutes, enable Go Live button if it exists
                                if (minutes < 15 && el.dataset.countdownType === 'start') {
                                    const goLiveBtn = document.querySelector(`[data-session-id="${el.dataset.sessionId}"] .go-live-btn`);
                                    if (goLiveBtn) {
                                        goLiveBtn.disabled = false;
                                        goLiveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                                        goLiveBtn.classList.add('hover:bg-primary-700');
                                    }
                                }
                            }
                            
                            el.textContent = countdownText;
                        }
                    });
                }, 1000);
            },
            
            handleNewBooking(data) {
                const sessionCard = document.querySelector(`[data-session-id="${data.session_id}"]`);
                if (!sessionCard) return;
                
                // Update booking count
                const bookingBadge = sessionCard.querySelector('.booking-badge');
                if (bookingBadge) {
                    const currentText = bookingBadge.textContent;
                    const parts = currentText.split('/');
                    if (parts.length === 2) {
                        const newCount = parseInt(parts[0]) + 1;
                        const maxCount = parseInt(parts[1]);
                        bookingBadge.textContent = `${newCount} / ${maxCount} Booked`;
                    }
                }
                
                // Show notification
                this.showToast(`New booking for "${data.session_title}"!`, 'success');
                
                // Enable 'Enter Room' button if this is the first booking
                const enterRoomBtn = sessionCard.querySelector('.enter-room-btn');
                if (enterRoomBtn && enterRoomBtn.disabled) {
                    enterRoomBtn.disabled = false;
                    enterRoomBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    enterRoomBtn.classList.add('hover:bg-primary-700');
                }
                
                // Play notification sound
                this.playNotificationSound('new-booking');
            },
            
            handleSessionUpdated(data) {
                // Show notification
                this.showToast(`Session "${data.session_title}" has been updated`, 'info');
                
                // Reload the page to show updated session data
                setTimeout(() => window.location.reload(), 2000);
            },
            
            handleSessionCancelled(data) {
                // Show notification
                this.showToast(`Session "${data.session_title}" has been cancelled`, 'warning');
                
                // Reload the page to remove cancelled session
                setTimeout(() => window.location.reload(), 2000);
            },
            
            handleSessionLive(data) {
                const sessionCard = document.querySelector(`[data-session-id="${data.session_id}"]`);
                if (!sessionCard) return;
                
                // Update session status badge
                const statusBadge = sessionCard.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.textContent = 'LIVE NOW';
                    statusBadge.classList.remove('bg-gray-100', 'text-gray-800');
                    statusBadge.classList.add('bg-red-100', 'text-red-800');
                }
                
                // Enable Enter Room button, disable Go Live button
                const enterRoomBtn = sessionCard.querySelector('.enter-room-btn');
                const goLiveBtn = sessionCard.querySelector('.go-live-btn');
                
                if (enterRoomBtn) {
                    enterRoomBtn.classList.remove('hidden');
                    enterRoomBtn.disabled = false;
                    enterRoomBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                
                if (goLiveBtn) {
                    goLiveBtn.classList.add('hidden');
                }
                
                // Show notification
                this.showToast(`Session "${data.session_title}" is now live!`, 'success');
                
                // Play notification sound
                this.playNotificationSound('session-live');
            },
            
            handleLearnerActivity(data) {
                // Show a toast notification
                const action = data.type === 'learner.join' ? 'joined' : 'left';
                this.showToast(`${data.learner_name} has ${action} the session "${data.session_title}"`, 'info');
                
                // Play notification sound for joins only
                if (data.type === 'learner.join') {
                    this.playNotificationSound('learner-join');
                }
            },
            
            playNotificationSound(soundType) {
                // Define sound URLs based on type
                const sounds = {
                    'new-booking': '/static/sounds/notification-booking.mp3',
                    'session-live': '/static/sounds/notification-live.mp3',
                    'learner-join': '/static/sounds/notification-join.mp3'
                };
                
                const soundUrl = sounds[soundType] || '/static/sounds/notification.mp3';
                
                // Create and play audio element
                const audio = new Audio(soundUrl);
                audio.volume = 0.5; // Set volume to 50%
                audio.play().catch(err => console.warn('Could not play notification sound:', err));
            },
            
            /**
             * Format a countdown string for display
             */
            formatCountdown(countdownStr) {
                // Just return the original countdown string for now
                // This could be enhanced with countdown logic if needed
                return countdownStr;
            },
            
            /**
             * Go Live/Prepare Room - Put a session in live mode and redirect to room
             */
            goLive(sessionId) {
                if (this.isBusy) return;
                this.isBusy = true;
                
                console.log("Preparing room for session ID:", sessionId);
                
                // Show preparing notification
                this.showToast('Preparing your session room...', 'info');
                
                // Make API call to set session as live
                fetch(`/sessions/api/sessions/${sessionId}/go_live/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        force: true, // Force go live even if time or booking conditions aren't met
                        notify_learners: true // Make sure we notify learners who booked this session
                    })
                })
                .then(response => {
                    console.log("Go Live API response status:", response.status);
                    
                    if (!response.ok) {
                        if (response.status === 403) {
                            throw new Error('Permission denied. Only the mentor who created this session can start it.');
                        } else if (response.status === 400) {
                            throw new Error('This session cannot be started right now. Please check its status.');
                        } else {
                            throw new Error('Failed to prepare room. Server error occurred.');
                        }
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log("Go Live API response data:", data);
                    
                    // Get room code from response
                    const roomCode = data.room_code || data.session?.room_code;
                    
                    if (!roomCode) {
                        throw new Error('No room code received from server');
                    }
                    
                    // Show success notification
                    this.showToast(data.message || 'Room ready! Redirecting to your live session...', 'success');
                    
                    // Redirect to session room with direct=true parameter
                    setTimeout(() => {
                        const redirectUrl = data.redirect_url || `/sessions/${roomCode}/join/?direct=true&mentor=true`;
                        console.log("Redirecting to:", redirectUrl);
                        window.location.href = redirectUrl;
                        
                        // Force refresh if not redirected in 2.5 seconds (backup)
                        setTimeout(() => {
                            console.log("Forcing page refresh as backup...");
                            window.location.reload();
                        }, 2500);
                    }, 1500); // Slightly longer delay to allow reading the success message
                })
                .catch(error => {
                    console.error('Error preparing room:', error);
                    
                    // Show detailed error notification
                    if (typeof showToast === 'function') {
                        showToast(error.message || 'Failed to prepare room. Please try again.', 'error');
                    } else {
                        alert(error.message || 'Failed to prepare room. Please try again.');
                    }
                    
                    this.isBusy = false;
                });
            },
            
            /**
             * Cancel a session
             */
            cancelSession(sessionId) {
                if (!confirm('Are you sure you want to cancel this session? This cannot be undone.')) {
                    return;
                }
                
                fetch(`/sessions/api/sessions/${sessionId}/cancel/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.csrfToken
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to cancel session');
                    }
                    return response.json();
                })
                .then(data => {
                    this.showToast(data.message || 'Session cancelled successfully.', 'success');
                    // Reload page to reflect changes
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Error cancelling session:', error);
                    this.showToast('Failed to cancel session. Please try again.', 'error');
                });
            },
            
            /**
             * Clone an existing session
             */
            cloneSession(sessionId) {
                if (this.isBusy) return;
                this.isBusy = true;
                
                fetch(`/sessions/api/sessions/${sessionId}/clone/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.csrfToken
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to clone session');
                    }
                    return response.json();
                })
                .then(data => {
                    this.showToast(data.message || 'Session cloned successfully.', 'success');
                    // Redirect to edit the cloned session
                    window.location.href = data.edit_url || `/users/dashboard/mentor/sessions/${data.session_id}/edit/`;
                })
                .catch(error => {
                    console.error('Error cloning session:', error);
                    this.showToast('Failed to clone session. Please try again.', 'error');
                    this.isBusy = false;
                });
            },
            
            /**
             * Show a toast notification
             */
            showToast(message, type = 'info') {
                if (window.showToast) {
                    window.showToast(message, type);
                } else {
                    alert(message);
                }
            }
        };
    }
</script>
{% endblock %}