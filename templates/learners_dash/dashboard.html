{% extends 'dashboard_base.html' %}

{% block title %}Learner Dashboard - PeerLearn{% endblock %}

{% block extra_head %}
<style>
    /* Hide scrollbar but allow scrolling */
    .hide-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
    .hide-scrollbar::-webkit-scrollbar {
        display: none;  /* Chrome, Safari and Opera */
    }
    
    /* Swipeable carousel styling */
    .snap-x {
        scroll-snap-type: x mandatory;
    }
    .snap-start {
        scroll-snap-align: start;
    }
    
    /* Mobile bottom navigation style fixes */
    .mobile-nav-spacer {
        height: 4rem; /* Match bottom nav height */
    }
</style>
<script>
    // Get active tab from URL parameter - expose globally
    window.getActiveTabFromURL = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab');
        return ['home', 'activity', 'sessions', 'mentors', 'notifications', 'profile'].includes(tab) ? tab : '{{ active_tab }}';
    }
    
    // Initialize Alpine.js data for tab management
    window.initializeAlpineData = function() {
        return {
            activeTab: getActiveTabFromURL() || 'home',
            setActiveTab(tab) {
                this.activeTab = tab;
                // Update URL without page reload
                const url = new URL(window.location);
                url.searchParams.set('tab', tab);
                window.history.pushState({}, '', url);
                
                // Update mobile nav if it exists
                const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
                mobileNavItems.forEach(item => {
                    if (item.dataset.tab === tab) {
                        item.classList.add('text-primary-600');
                        item.classList.remove('text-gray-500');
                    } else {
                        item.classList.remove('text-primary-600');
                        item.classList.add('text-gray-500');
                    }
                });
            }
        };
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        // Function to refresh activity content with AJAX
        function refreshActivityContent() {
            const activityTab = document.getElementById('activity-subtab');
            if (activityTab) {
                const activityContent = document.getElementById('activity-content');
                if (activityContent) {
                    // Create loading spinner
                    const loadingSpinner = document.createElement('div');
                    loadingSpinner.className = 'flex justify-center items-center py-12';
                    loadingSpinner.innerHTML = `
                        <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-primary-600 font-medium">Loading...</span>
                    `;
                    activityContent.innerHTML = '';
                    activityContent.appendChild(loadingSpinner);
                    
                    // Fetch updated content
                    fetch('/users/dashboard/learner/activity-partial/')
                        .then(response => response.text())
                        .then(html => {
                            activityTab.innerHTML = html;
                            // Re-initialize feather icons for the new content
                            if (window.feather) {
                                feather.replace();
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching activity content:', error);
                            activityContent.innerHTML = `
                                <div class="text-center py-12">
                                    <div class="text-red-600 mb-4">
                                        <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-medium text-gray-900 mb-2">Could not load activities</h3>
                                    <p class="text-gray-600 max-w-md mx-auto mb-4">
                                        There was a problem loading your activities. Please try again.
                                    </p>
                                    <button onClick="refreshActivityContent()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Retry
                                    </button>
                                </div>
                            `;
                        });
                }
            }
        }
        
        // Set up interval to refresh activity content periodically
        setInterval(function() {
            // Only refresh when activity tab is visible
            if (document.querySelector('[x-show="activeTab === \'activity\'"]') && 
                !document.querySelector('[x-show="activeTab === \'activity\'"]').style.display === 'none') {
                refreshActivityContent();
            }
        }, 60000); // Refresh every minute
        
        // Expose the refresh function globally to allow manual refresh
        window.refreshActivityContent = refreshActivityContent;
        
        // Initialize countdown timers
        function updateTimers() {
            document.querySelectorAll('.session-countdown').forEach(function(element) {
                const timestamp = parseInt(element.getAttribute('data-timestamp'));
                const now = Math.floor(Date.now() / 1000);
                const diff = timestamp - now;
                
                if (diff <= 0) {
                    // Session is live or past
                    if (diff > -3600) { // Within one hour of start
                        element.innerHTML = '<span class="text-red-600 font-semibold animate-pulse">LIVE NOW</span>';
                        element.classList.add('live');
                    } else {
                        element.innerHTML = 'Ended';
                        element.classList.add('ended');
                    }
                    return;
                }
                
                // Calculate days, hours, minutes, seconds
                const days = Math.floor(diff / 86400);
                const hours = Math.floor((diff % 86400) / 3600);
                const minutes = Math.floor((diff % 3600) / 60);
                const seconds = diff % 60;
                
                // Display the countdown
                if (days > 0) {
                    element.innerHTML = `${days}d ${hours}h ${minutes}m`;
                } else if (hours > 0) {
                    element.innerHTML = `${hours}h ${minutes}m ${seconds}s`;
                } else {
                    element.innerHTML = `${minutes}m ${seconds}s`;
                    element.classList.add('urgent');
                }
            });
        }
        
        // Initialize and update every second
        updateTimers();
        setInterval(updateTimers, 1000);
        
        // Connect to WebSocket for real-time updates with exponential backoff reconnection
        const setupWebSocket = () => {
            // Always try WebSocket first, regardless of environment
            // We'll fall back to polling if WebSocket connection fails
            
            let socket = null;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 3;
            const baseReconnectDelay = 1000; // Start with 1 second delay
            
            function connect() {
                const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
                const wsUrl = `${protocol}//${window.location.host}/ws/sessions/`;
                
                // Close existing socket if any
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.close();
                }
                
                socket = new WebSocket(wsUrl);
                
                socket.onopen = function(e) {
                    console.log('WebSocket connection established');
                    // Reset reconnect attempts on successful connection
                    reconnectAttempts = 0;
                    
                    // Immediately request current session data
                    socket.send(JSON.stringify({
                        type: 'fetch_sessions'
                    }));
                };
                
                socket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    // Update sessions data
                    if (data.type === 'sessions_update' && data.sessions) {
                        updateSessionsDisplay(data.sessions);
                    }
                    
                    // Update attendee count
                    else if (data.type === 'attendee_update') {
                        const countElement = document.querySelector(`.attendee-count[data-session-id="${data.session_id}"]`);
                        if (countElement) {
                            countElement.textContent = data.count;
                        }
                    }
                    
                    // Update session status
                    else if (data.type === 'session_status_update') {
                        const sessionCard = document.querySelector(`.session-card[data-session-id="${data.session_id}"]`);
                        if (sessionCard) {
                            sessionCard.setAttribute('data-status', data.status);
                            updateSessionCardUI(sessionCard, data.status);
                        }
                    }
                    
                    // Handle booking confirmations
                    else if (data.type === 'booking_confirmation') {
                        showNotification('Your booking has been confirmed!', 'success');
                        
                        // Update booking status via AJAX
                        if (data.booking_id) {
                            updateBookingDisplay(data.booking_id);
                        }
                    }
                };
                
                socket.onclose = function(event) {
                    if (reconnectAttempts < maxReconnectAttempts) {
                        // Calculate exponential backoff delay
                        const delay = Math.min(30000, baseReconnectDelay * Math.pow(2, reconnectAttempts));
                        console.log(`WebSocket disconnected. Reconnecting in ${delay/1000} seconds...`);
                        
                        setTimeout(() => {
                            reconnectAttempts++;
                            connect();
                        }, delay);
                    } else {
                        console.log('WebSocket disconnected. Falling back to AJAX polling.');
                        // Fall back to polling after max reconnect attempts
                        setupPolling();
                    }
                };
                
                socket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    // Errors will trigger onclose, which handles reconnection
                };
            }
            
            // Start the connection
            connect();
            
            // Keep socket alive with ping every 30 seconds
            const pingInterval = setInterval(() => {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'ping' }));
                }
            }, 30000);
            
            // Return cleanup function
            return () => {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.close();
                }
                clearInterval(pingInterval);
            };
        };
        
        // Polling fallback when WebSockets aren't available
        function setupPolling() {
            console.log('Setting up AJAX polling fallback for session updates');
            let pollingInterval;
            
            // Function to fetch session data via AJAX
            const fetchSessionData = () => {
                fetch('/sessions/api/status/')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.sessions) {
                            updateSessionsDisplay(data.sessions);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching session data:', error);
                    });
            };
            
            // Initial fetch
            fetchSessionData();
            
            // Set up polling interval (every 10 seconds)
            pollingInterval = setInterval(fetchSessionData, 10000);
            
            // Return cleanup function
            return () => {
                clearInterval(pollingInterval);
            };
        };
        
        // Initialize WebSocket connection
        try {
            setupWebSocket();
        } catch (error) {
            console.error('WebSocket initialization failed:', error);
            setupPolling();
        }
        
        // Function to update the display with session data
        function updateSessionsDisplay(sessions) {
            // Implementation of session display update logic
            console.log('Updating sessions display with data:', sessions);
            
            // If no sessions, show empty state
            const sessionsContainer = document.getElementById('upcoming-sessions');
            if (!sessions || sessions.length === 0) {
                sessionsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500">No upcoming sessions found.</p>
                        <a href="/sessions/browse/" class="mt-4 inline-block text-blue-600 hover:text-blue-800">Browse Available Sessions</a>
                    </div>
                `;
                return;
            }
            
            // Update sessions in the UI
            let sessionsHTML = '';
            sessions.forEach(session => {
                const sessionDate = new Date(session.schedule);
                const formattedDate = sessionDate.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                sessionsHTML += `
                    <div class="session-card bg-white rounded-lg shadow-md p-4 mb-4 border-l-4 border-blue-500" 
                         data-session-id="${session.id}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-semibold text-lg">${session.title}</h3>
                                <p class="text-sm text-gray-600">${formattedDate}</p>
                                <p class="text-sm text-gray-700 mt-2">
                                    <span class="font-medium">Mentor:</span> ${session.mentor_name}
                                </p>
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 text-xs rounded-full 
                                    ${session.status === 'scheduled' ? 'bg-green-100 text-green-800' : 
                                      session.status === 'in_progress' ? 'bg-blue-100 text-blue-800' : 
                                      'bg-gray-100 text-gray-800'}">
                                    ${session.status === 'scheduled' ? 'Scheduled' : 
                                      session.status === 'in_progress' ? 'In Progress' : 
                                      session.status === 'completed' ? 'Completed' : 'Unknown'}
                                </span>
                                ${session.status === 'in_progress' ? 
                                    `<a href="/sessions/join/${session.id}/" 
                                        class="mt-2 block px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded">
                                        Join Now
                                    </a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            sessionsContainer.innerHTML = sessionsHTML;
        };

        
        // Document ready function to initialize WebSocket connection
        document.addEventListener('DOMContentLoaded', () => {
            try {
                setupWebSocket();
            } catch (error) {
                console.error('WebSocket initialization failed:', error);
                setupPolling();
            }
        });
        
        // Helper function to show notifications
        const showNotification = (message, type = 'info') => {
            window.dispatchEvent(new CustomEvent('toast', {
                detail: { message, type }
            }));
        };
        
        // Function to update activity list with new booking data
        function updateActivityList(bookingData) {
            const activityList = document.getElementById('bookings-list');
            if (!activityList) return;
            
            // Create a new booking item element
            const bookingItem = document.createElement('div');
            bookingItem.className = 'booking-item flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-white rounded-lg shadow-sm mb-3 border-l-4 border-primary-500';
            bookingItem.setAttribute('data-booking-id', bookingData.id);
            
            // Format date for display
            const bookingDate = new Date(bookingData.session.schedule);
            const formattedDate = bookingDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Create booking item content
            bookingItem.innerHTML = `
                <div class="flex-1">
                    <h4 class="text-lg font-medium text-gray-900">${bookingData.session.title}</h4>
                    <div class="mt-1 text-sm text-gray-600">
                        <p class="flex items-center"><i data-feather="calendar" class="w-4 h-4 mr-1"></i> ${formattedDate}</p>
                        <p class="flex items-center mt-1"><i data-feather="user" class="w-4 h-4 mr-1"></i> ${bookingData.session.mentor.name}</p>
                    </div>
                </div>
                <div class="mt-3 sm:mt-0 flex flex-col sm:items-end">
                    <span class="booking-status text-green-600 font-medium">Confirmed</span>
                    <span class="text-sm text-gray-500 mt-1">${bookingData.session.duration} minutes</span>
                </div>
            `;
            
            // Add the new booking to the top of the list
            if (activityList.firstChild) {
                activityList.insertBefore(bookingItem, activityList.firstChild);
            } else {
                activityList.appendChild(bookingItem);
            }
            
            // Initialize Feather icons for the new element
            if (window.feather) {
                window.feather.replace({ 'class': 'w-4 h-4 mr-1' });
            }
        }
        
        function updateSessionCardUI(card, status) {
            // Update card UI based on session status
            card.querySelectorAll('.status-badge').forEach(badge => {
                badge.classList.add('hidden');
            });
            
            const statusBadge = card.querySelector(`.status-badge[data-status="${status}"]`);
            if (statusBadge) {
                statusBadge.classList.remove('hidden');
            }
            
            // Update action buttons
            if (status === 'live') {
                const joinBtn = card.querySelector('.join-btn');
                if (joinBtn) {
                    joinBtn.classList.remove('hidden');
                }
            }
        }
        
        // Function to refresh activity tab content without full page reload
        function refreshActivityContent() {
            const activityContainer = document.getElementById('activity-content');
            if (!activityContainer) return;
            
            // Show loading state
            activityContainer.innerHTML = '<div class="flex justify-center py-10"><div class="spinner"></div></div>';
            
            // Fetch the activity content
            fetch('/users/dashboard/learner/activity-partial/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch activity content');
                    }
                    return response.text();
                })
                .then(html => {
                    activityContainer.innerHTML = html;
                    // Initialize any components in the new content
                    if (window.feather) {
                        window.feather.replace();
                    }
                })
                .catch(error => {
                    console.error('Error refreshing activity content:', error);
                    activityContainer.innerHTML = '<div class="text-center py-10 text-red-600">Failed to load content. <button onclick="refreshActivityContent()" class="underline">Try again</button></div>';
                });
        }
    });
</script>

<style>
    .spinner {
        border: 3px solid rgba(59, 130, 246, 0.2);
        border-radius: 50%;
        border-top: 3px solid rgba(59, 130, 246, 1);
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 md:py-8">
        <!-- Dashboard Header -->
        <div class="mb-6 md:mb-8">
            <h1 class="text-xl font-bold text-gray-900 md:text-2xl lg:text-3xl">Welcome, {{ user.first_name|default:user.username }}</h1>
            <p class="mt-2 text-sm text-gray-600">
                Discover and connect with expert mentors tailored to your learning needs.
            </p>

            <!-- Network Status Banner -->
            <div x-data="{ isOffline: false }" x-init="
                window.addEventListener('online', () => { isOffline = false });
                window.addEventListener('offline', () => { isOffline = true });
                isOffline = !navigator.onLine;
            ">
                <div x-show="isOffline" class="mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 flex items-center" style="display: none;">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">
                            You're offline. Working with cached data.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Tabs -->
        <div x-data="{ 
            activeTab: '{{ active_tab }}',
            setActiveTab(tab) {
                this.activeTab = tab;
                // Update URL without page reload
                const url = new URL(window.location);
                url.searchParams.set('tab', tab);
                window.history.pushState({}, '', url);
            }
        }">
            <!-- Tab Navigation -->
            <div class="hidden md:block border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8 overflow-x-auto hide-scrollbar">
                    <button @click="setActiveTab('home')" :class="{'border-primary-600 text-primary-600': activeTab === 'home', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'home'}" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition-colors">
                        <i data-feather="home" class="inline-block w-4 h-4 mr-1 align-text-bottom"></i>
                        Home
                    </button>
                    <button @click="setActiveTab('activity')" :class="{'border-primary-600 text-primary-600': activeTab === 'activity', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'activity'}" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition-colors">
                        <i data-feather="activity" class="inline-block w-4 h-4 mr-1 align-text-bottom"></i>
                        Activity
                    </button>
                    <button @click="setActiveTab('mentors')" :class="{'border-primary-600 text-primary-600': activeTab === 'mentors', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'mentors'}" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition-colors">
                        <i data-feather="users" class="inline-block w-4 h-4 mr-1 align-text-bottom"></i>
                        Mentors
                    </button>
                    <button @click="setActiveTab('notifications')" :class="{'border-primary-600 text-primary-600': activeTab === 'notifications', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'notifications'}" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition-colors relative">
                        <i data-feather="bell" class="inline-block w-4 h-4 mr-1 align-text-bottom"></i>
                        Notifications
                        {% if unread_notifications_count > 0 %}
                        <span class="absolute top-0 right-0 -mt-1 -mr-1 flex h-4 w-4">
                            <span class="relative inline-flex rounded-full h-4 w-4 bg-red-500 text-xs text-white justify-center items-center">
                                {{ unread_notifications_count }}
                            </span>
                        </span>
                        {% endif %}
                    </button>
                    <button @click="setActiveTab('profile')" :class="{'border-primary-600 text-primary-600': activeTab === 'profile', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'profile'}" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition-colors">
                        <i data-feather="user" class="inline-block w-4 h-4 mr-1 align-text-bottom"></i>
                        Profile
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="mt-4">
                <!-- Home Tab -->
                <div x-show="activeTab === 'home'" x-transition:enter="transition-opacity duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
                    {% include 'learners_dash/tabs/home.html' %}
                </div>

                <!-- Activity Tab -->
                <div x-show="activeTab === 'activity'" x-transition:enter="transition-opacity duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" style="display: none;">
                    {% include 'learners_dash/tabs/activity.html' %}
                </div>
                
                <!-- Mentors Tab -->
                <div x-show="activeTab === 'mentors'" x-transition:enter="transition-opacity duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" style="display: none;">
                    {% include 'learners_dash/tabs/mentors.html' %}
                </div>
                
                <!-- Notifications Tab -->
                <div x-show="activeTab === 'notifications'" x-transition:enter="transition-opacity duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" style="display: none;">
                    {% include 'learners_dash/tabs/notifications.html' %}
                </div>

                <!-- Profile Tab -->
                <div x-show="activeTab === 'profile'" x-transition:enter="transition-opacity duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" style="display: none;">
                    {% include 'learners_dash/tabs/profile.html' %}
                </div>
            </div>
            
            <!-- Bottom mobile navigation spacer -->
            <div class="block md:hidden mobile-nav-spacer"></div>
        </div>
    </div>
</div>

<!-- Booking Modal -->
<div x-data="{ isOpen: false, sessionId: null, sessionData: {} }" 
     @open-booking-modal.window="
        isOpen = true; 
        sessionId = $event.detail.sessionId;
        sessionData = $event.detail.sessionData;
     "
     x-show="isOpen" 
     class="fixed inset-0 z-50 overflow-y-auto" 
     style="display: none;"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    
    <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div x-show="isOpen" @click="isOpen = false" class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-75" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-75" x-transition:leave-end="opacity-0"></div>
        
        <!-- Modal panel -->
        <div x-show="isOpen" class="inline-block w-full max-w-xl p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-white rounded-lg shadow-xl sm:my-12" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">
            <div class="absolute top-0 right-0 pt-4 pr-4">
                <button @click="isOpen = false" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="mt-2">
                <h3 class="text-xl font-semibold text-gray-900" x-text="sessionData.title || 'Book Session'"></h3>
                <div class="mt-4 space-y-4">
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <i data-feather="calendar" class="w-4 h-4"></i>
                        <span x-text="sessionData.schedule || 'Loading...'"></span>
                    </div>
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <i data-feather="clock" class="w-4 h-4"></i>
                        <span x-text="sessionData.duration ? sessionData.duration + ' minutes' : 'Loading...'"></span>
                    </div>
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <i data-feather="user" class="w-4 h-4"></i>
                        <span x-text="sessionData.mentor_name || 'Loading...'"></span>
                    </div>
                    <div class="flex items-center space-x-2 text-sm font-semibold text-primary-600">
                        <i data-feather="tag" class="w-4 h-4"></i>
                        <span x-text="sessionData.price ? 'â‚¹' + sessionData.price : 'Loading...'"></span>
                    </div>
                    
                    <div class="pt-3 border-t border-gray-200">
                        <h4 class="font-medium text-gray-900">Session Description</h4>
                        <p class="mt-2 text-sm text-gray-600" x-text="sessionData.description || 'Loading session details...'"></p>
                    </div>
                    
                    <div class="pt-3 border-t border-gray-200">
                        <h4 class="font-medium text-gray-900">Topics Covered</h4>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <template x-for="topic in sessionData.topics || []" :key="topic">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800" x-text="topic"></span>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 sm:mt-8">
                <div class="flex flex-col space-y-3 sm:flex-row sm:space-y-0 sm:space-x-3 justify-end">
                    <button @click="isOpen = false" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        Cancel
                    </button>
                    <form x-bind:action="'/sessions/' + sessionId + '/book/'" method="POST" class="inline">
                        {% csrf_token %}
                        <button type="submit" x-bind:class="{'opacity-50 cursor-not-allowed': sessionData.is_booked}" x-bind:disabled="sessionData.is_booked" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 border border-transparent rounded-md shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <span x-show="!sessionData.is_free">Pay & Book Now</span>
                            <span x-show="sessionData.is_free">Book Now (Free)</span>
                        </button>
                    </form>
                </div>
                <p x-show="sessionData.is_booked" class="mt-2 text-sm text-center text-red-600">You have already booked this session.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Setup booking buttons
        document.querySelectorAll('.book-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const sessionId = this.getAttribute('data-session-id');
                const sessionCard = document.querySelector(`.session-card[data-session-id="${sessionId}"]`);
                
                // Extract session data from the card
                const sessionData = {
                    title: sessionCard.querySelector('.session-title').textContent,
                    description: sessionCard.getAttribute('data-description'),
                    schedule: sessionCard.querySelector('.session-schedule').textContent,
                    duration: sessionCard.getAttribute('data-duration'),
                    mentor_name: sessionCard.querySelector('.mentor-name').textContent,
                    price: sessionCard.getAttribute('data-price'),
                    is_free: sessionCard.getAttribute('data-price') === '0',
                    is_booked: sessionCard.getAttribute('data-is-booked') === 'true',
                    topics: JSON.parse(sessionCard.getAttribute('data-topics') || '[]')
                };
                
                // Open the booking modal with session data
                window.dispatchEvent(new CustomEvent('open-booking-modal', {
                    detail: {
                        sessionId: sessionId,
                        sessionData: sessionData
                    }
                }));
            });
        });
        
        // Handle offline storage
        if ('localStorage' in window) {
            // Save form data on change
            document.querySelectorAll('.autosave-form input, .autosave-form textarea, .autosave-form select').forEach(input => {
                input.addEventListener('change', function() {
                    const form = this.closest('.autosave-form');
                    const formId = form.getAttribute('id');
                    const formData = new FormData(form);
                    const formDataObj = {};
                    
                    formData.forEach((value, key) => {
                        formDataObj[key] = value;
                    });
                    
                    localStorage.setItem(`form_${formId}`, JSON.stringify(formDataObj));
                });
            });
            
            // Load saved form data
            document.querySelectorAll('.autosave-form').forEach(form => {
                const formId = form.getAttribute('id');
                const savedData = localStorage.getItem(`form_${formId}`);
                
                if (savedData) {
                    try {
                        const formData = JSON.parse(savedData);
                        
                        for (const [key, value] of Object.entries(formData)) {
                            const input = form.querySelector(`[name="${key}"]`);
                            if (input) {
                                if (input.type === 'checkbox') {
                                    input.checked = value === 'on';
                                } else {
                                    input.value = value;
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error loading saved form data:', e);
                    }
                }
            });
        }
    });
</script>
{% endblock %}